<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Business Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #075E54;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .status.active {
            background: #10b98120;
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status.inactive {
            background: #ef444420;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .status i {
            font-size: 16px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .card-icon.green { 
            background: #10b98120;
            color: var(--success);
        }

        .card-icon.blue {
            background: #3b82f620;
            color: var(--info);
        }

        .card-icon.orange {
            background: #f59e0b20;
            color: var(--warning);
        }
        
        .card h2 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        
        .stat {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
        }

        .stat:hover {
            padding-left: 8px;
        }
        
        .stat:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-label i {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        .stat-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-trend {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .stat-trend.up {
            color: var(--success);
        }

        .stat-trend.down {
            color: var(--error);
        }

        .stat-trend i {
            font-size: 14px;
        }
        
        .settings-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 24px;
        }

        .form-group.inline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--background);
            border-radius: var(--radius);
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .form-group.inline:hover {
            background: #f1f5f9;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-group p {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            transition: all 0.2s;
            background: var(--background);
            color: var(--text-primary);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .3s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--text-secondary);
        }

        .btn i {
            font-size: 18px;
        }
        
        .message-templates {
            margin-top: 32px;
        }
        
        .template-item {
            background: var(--background);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .template-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .template-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: #10b98120;
            color: var(--success);
            font-weight: 600;
        }
        
        .template-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 28px;
            background: var(--background);
            padding: 4px;
            border-radius: var(--radius);
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Quick Actions Card Enhancements */
        .quick-actions-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .quick-actions-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }

        .quick-actions-card h2,
        .quick-actions-card .stat-label {
            color: white;
        }

        .quick-actions-card .card-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Test Message Form Styles */
        .test-message-section {
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .test-message-section h3 {
            color: white;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .test-message-section input,
        .test-message-section textarea,
        .test-message-section select {
            background: rgba(255,255,255,0.9);
            border: 2px solid transparent;
            color: var(--text-primary);
        }

        .test-message-section input:focus,
        .test-message-section textarea:focus,
        .test-message-section select:focus {
            background: white;
            border-color: var(--primary);
        }

        .test-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .test-result.success {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .test-result.error {
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Flow Cards */
        .flow-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .flow-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .flow-info h4 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .flow-meta {
            display: flex;
            gap: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .flow-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .flow-meta i {
            font-size: 16px;
            color: var(--primary);
        }

        .flow-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .flow-status.active {
            background: #10b98120;
            color: var(--success);
        }

        .flow-status.inactive {
            background: #64748b20;
            color: var(--text-secondary);
        }

        .flow-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--background);
            border-radius: var(--radius);
        }

        .flow-actions {
            display: flex;
            gap: 8px;
        }

        .flow-actions button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flow-actions button:hover {
            background: var(--background);
            border-color: var(--primary);
            color: var(--primary);
        }

        .flow-actions button.delete:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Loading States */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Additional Styles */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
        }

        .tab i {
            margin-right: 6px;
            font-size: 16px;
        }

        /* Enhanced Tab Styles */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            background: var(--background);
            padding: 4px;
            border-radius: var(--radius);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            min-width: fit-content;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.5);
        }

        .tab.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--background) 25%, var(--border) 50%, var(--background) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Advanced Cart Recovery Styles */
        .recovery-step {
            position: relative;
        }

        .recovery-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -24px;
            width: 16px;
            height: 2px;
            background: var(--border);
            transform: translateY(-50%);
        }

        .recovery-step:last-child::after {
            display: none;
        }

        /* Message Bubble Styles */
        .message-bubble {
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 8px 0;
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        /* Campaign Card Hover Effects */
        .campaign-type-card {
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .campaign-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .campaign-type-card:hover::before {
            left: 100%;
        }

        .campaign-type-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--text-muted); }
        .status-dot.away { background: var(--warning); }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                padding: 20px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .tabs {
                justify-content: flex-start;
            }

            .tab {
                padding: 10px 16px;
                font-size: 13px;
            }

            .tab i {
                margin-right: 4px;
                font-size: 14px;
            }

            .flow-header {
                flex-direction: column;
                gap: 12px;
            }

            .flow-meta {
                flex-wrap: wrap;
            }

            /* Stack charts on mobile */
            .chart-container {
                margin-bottom: 20px;
            }

            [style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            [style*="grid-template-columns: 1fr 2fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .stat-value {
                font-size: 24px;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon">
                        <i class="ri-whatsapp-fill"></i>
                    </div>
                    <div>
                        <h1>WhatsApp Business Dashboard</h1>
                        <p class="header-subtitle">Manage your WhatsApp automation and messaging</p>
                    </div>
                </div>
                <span class="status active">
                    <i class="ri-checkbox-circle-fill"></i>
                    Connected
                </span>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon green">
                        <i class="ri-bar-chart-2-fill"></i>
                    </div>
                    <h2>Statistics</h2>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-message-3-line"></i>
                        Messages Sent Today
                    </span>
                    <span id="messagesToday" class="stat-value">
                        -
                        <span class="stat-trend up">
                            <i class="ri-arrow-up-s-line"></i>
                            -
                        </span>
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-user-3-line"></i>
                        Customers with WhatsApp
                    </span>
                    <span id="customersWhatsApp" class="stat-value">
                        -
                        <span class="stat-trend up">
                            <i class="ri-arrow-up-s-line"></i>
                            -
                        </span>
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-send-plane-2-line"></i>
                        Total Messages Sent
                    </span>
                    <span id="totalMessages" class="stat-value">-</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon orange">
                        <i class="ri-money-dollar-circle-fill"></i>
                    </div>
                    <h2>Revenue Impact</h2>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-calendar-line"></i>
                        Revenue (30 days)
                    </span>
                    <span id="revenue30Days" class="stat-value">
                        $0.00
                        <span class="stat-trend up">
                            <i class="ri-arrow-up-s-line"></i>
                            -
                        </span>
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-percent-line"></i>
                        WhatsApp Conversion Rate
                    </span>
                    <span id="conversionRate" class="stat-value">-%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">
                        <i class="ri-shopping-cart-2-line"></i>
                        Avg. Order Value
                    </span>
                    <span id="avgOrderValue" class="stat-value">$0.00</span>
                </div>
            </div>
            
            <!-- Quick Actions Card with Test Message Form -->
            <div class="card quick-actions-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="ri-flashlight-fill"></i>
                    </div>
                    <h2>Quick Actions</h2>
                </div>
                
                <!-- Test Message Section -->
                <div class="test-message-section">
                    <h3>Send Test Message</h3>
                    
                    <div class="form-group">
                        <input type="text" 
                               id="testPhoneInput" 
                               placeholder="WhatsApp number (e.g., +1234567890)"
                               style="width: 100%; margin-bottom: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <textarea id="testMessageInput" 
                                  placeholder="Test message (optional)"
                                  style="width: 100%; margin-bottom: 10px; min-height: 60px;">Hello! This is a test message from your Shopify store. 🛍️</textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendWhatsAppTest()">
                        Send Test WhatsApp
                    </button>
                    
                    <div id="testResult" class="test-result"></div>
                    
                    <!-- Template Test Section -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">Test Notification Templates</h4>
                        <select id="templateSelect" style="margin-bottom: 10px; width: 100%;">
                            <option value="order_placed">Order Confirmation</option>
                            <option value="abandoned_cart_1h">Abandoned Cart</option>
                            <option value="welcome_customer">Welcome Message</option>
                            <option value="order_fulfilled">Shipping Update</option>
                        </select>
                        <button class="btn btn-primary" onclick="sendTemplateTest()">
                            Test Template
                        </button>
                        <div id="templateResult" class="test-result"></div>
                    </div>
                </div>
                
                <!-- Other buttons -->
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="syncContacts()">
                    <i class="ri-refresh-line"></i>
                    Sync Contacts
                </button>
                <button class="btn btn-primary" style="width: 100%;" onclick="viewLogs()">
                    <i class="ri-file-list-3-line"></i>
                    View Logs
                </button>
            </div>
        </div>
        
        <div class="settings-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('analytics')">
                    <i class="ri-bar-chart-2-line"></i>
                    Analytics
                </button>
                <button class="tab" onclick="switchTab('customers')">
                    <i class="ri-user-3-line"></i>
                    Customers
                </button>
                <button class="tab" onclick="switchTab('messages')">
                    <i class="ri-chat-3-line"></i>
                    Messages
                </button>
                <button class="tab" onclick="switchTab('automation')">
                    <i class="ri-settings-3-line"></i>
                    Automation
                </button>
                <button class="tab" onclick="switchTab('campaigns')">
                    <i class="ri-megaphone-line"></i>
                    Campaigns
                </button>
                <button class="tab" onclick="switchTab('templates')">
                    <i class="ri-file-text-line"></i>
                    Templates
                </button>
                <button class="tab" onclick="switchTab('widget')">
                    <i class="ri-whatsapp-line"></i>
                    WhatsApp Widget
                </button>
                <button class="tab" onclick="switchTab('settings')">
                    <i class="ri-settings-line"></i>
                    Settings
                </button>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Analytics & Reports</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">Track your WhatsApp performance and ROI</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <select class="form-input" style="width: auto; padding: 8px 12px;">
                            <option>Last 7 days</option>
                            <option>Last 30 days</option>
                            <option>Last 90 days</option>
                            <option>Last 12 months</option>
                        </select>
                        <button class="btn btn-secondary">
                            <i class="ri-download-line"></i>
                            Export Report
                        </button>
                    </div>
                </div>

                <!-- Performance Overview Cards -->
                <div class="grid" style="margin-bottom: 32px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon green">
                                <i class="ri-send-plane-2-fill"></i>
                            </div>
                            <h3>Message Performance</h3>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-check-double-line"></i>
                                Delivery Rate
                            </span>
                            <span id="analyticsDeliveryRate" class="stat-value">
                                -%
                                <span class="stat-trend up">
                                    <i class="ri-arrow-up-s-line"></i>
                                    -
                                </span>
                            </span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-eye-line"></i>
                                Open Rate
                            </span>
                            <span id="analyticsOpenRate" class="stat-value">-%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-mouse-line"></i>
                                Click Rate
                            </span>
                            <span id="analyticsClickRate" class="stat-value">-%</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon blue">
                                <i class="ri-shopping-cart-fill"></i>
                            </div>
                            <h3>Revenue Impact</h3>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-money-dollar-circle-line"></i>
                                WhatsApp Revenue
                            </span>
                            <span id="analyticsWhatsAppRevenue" class="stat-value">
                                $0
                                <span class="stat-trend up">
                                    <i class="ri-arrow-up-s-line"></i>
                                    -
                                </span>
                            </span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-percent-line"></i>
                                Conversion Rate
                            </span>
                            <span id="analyticsConversionRate" class="stat-value">-%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-calculator-line"></i>
                                ROAS
                            </span>
                            <span id="analyticsROAS" class="stat-value">-x</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon orange">
                                <i class="ri-shopping-bag-2-fill"></i>
                            </div>
                            <h3>Cart Recovery</h3>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-shopping-cart-2-line"></i>
                                Carts Recovered
                            </span>
                            <span class="stat-value">
                                <span id="cartsRecoveredStat">0</span>
                                <span class="stat-trend up">
                                    <i class="ri-arrow-up-s-line"></i>
                                    <span id="cartsRecoveredGrowthStat">0%</span>
                                </span>
                            </span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-percent-line"></i>
                                Recovery Rate
                            </span>
                            <span id="recoveryRateStat" class="stat-value">0%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">
                                <i class="ri-money-dollar-box-line"></i>
                                Recovered Value
                            </span>
                            <span id="recoveredValueStat" class="stat-value">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
                    <!-- Main Chart -->
                    <div class="chart-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0;">Message Volume & Revenue</h3>
                            <div style="display: flex; gap: 16px; font-size: 14px;">
                                <span style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 2px;"></div>
                                    Messages Sent
                                </span>
                                <span style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: var(--info); border-radius: 2px;"></div>
                                    Revenue Generated
                                </span>
                            </div>
                        </div>
                        <canvas id="mainChart" width="600" height="300"></canvas>
                    </div>

                    <!-- Message Types Breakdown -->
                    <div class="chart-container">
                        <h3 style="margin: 0 0 24px 0;">Message Types</h3>
                        <canvas id="pieChart" width="300" height="300"></canvas>
                    </div>
                </div>

                <!-- Top Performing Campaigns -->
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="margin: 0;">Top Performing Campaigns</h3>
                        <button class="btn btn-secondary" onclick="navigateToTab('campaigns')">
                            <i class="ri-arrow-right-line"></i>
                            View All
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="campaignsTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">Campaign</th>
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">Messages</th>
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">Delivered</th>
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">Clicked</th>
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">Revenue</th>
                                    <th style="text-align: left; padding: 16px 12px; font-weight: 600; color: var(--text-primary);">ROI</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <!-- Dynamic campaign data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Customers Tab -->
            <div id="customers" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Customer Management</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">Manage your WhatsApp contacts and conversations</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="syncCustomers()">
                            <i class="ri-refresh-line"></i>
                            Sync from Shopify
                        </button>
                        <button class="btn btn-primary" onclick="showImportModal()">
                            <i class="ri-upload-2-line"></i>
                            Import Contacts
                        </button>
                    </div>
                </div>

                <!-- Customer Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div id="totalCustomersStat" style="background: var(--background); padding: 20px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">-</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Total Customers</div>
                    </div>
                    <div id="withWhatsAppStat" style="background: var(--background); padding: 20px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);">-</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">With WhatsApp</div>
                    </div>
                    <div id="activeCustomersStat" style="background: var(--background); padding: 20px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--info);">-</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Active</div>
                    </div>
                    <div id="inactiveCustomersStat" style="background: var(--background); padding: 20px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);">-</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Inactive</div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div style="background: var(--surface); padding: 20px; border-radius: var(--radius); margin-bottom: 24px; border: 1px solid var(--border);">
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <input type="text" placeholder="Search customers..." class="form-input" style="flex: 1; min-width: 200px;" id="customerSearch">
                        <select class="form-input" style="width: auto;">
                            <option>All Customers</option>
                            <option>VIP Customers</option>
                            <option>Recent Buyers</option>
                            <option>Inactive</option>
                            <option>Opted Out</option>
                        </select>
                        <select class="form-input" style="width: auto;">
                            <option>All Regions</option>
                            <option>North America</option>
                            <option>Europe</option>
                            <option>Asia Pacific</option>
                        </select>
                        <button class="btn btn-secondary">
                            <i class="ri-filter-3-line"></i>
                            More Filters
                        </button>
                    </div>
                </div>

                <!-- Customer List -->
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Customer List</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 8px 16px;">
                                <i class="ri-download-line"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <div id="customerTable" class="table-container">
                        <!-- Customer table will be populated here -->
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="ri-user-3-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            <p>Loading customer data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Messages & Conversations</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">View and manage all WhatsApp conversations</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary">
                            <i class="ri-search-line"></i>
                            Search Messages
                        </button>
                        <button class="btn btn-primary" onclick="showBulkMessageModal()">
                            <i class="ri-chat-new-line"></i>
                            Send Bulk Message
                        </button>
                    </div>
                </div>

                <!-- Message Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div style="background: var(--background); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div id="messagesTodayStat" style="font-size: 20px; font-weight: 700; color: var(--success);">0</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Today</div>
                    </div>
                    <div style="background: var(--background); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div id="messagesWeekStat" style="font-size: 20px; font-weight: 700; color: var(--info);">0</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">This Week</div>
                    </div>
                    <div style="background: var(--background); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div id="deliveryRateStat" style="font-size: 20px; font-weight: 700; color: var(--warning);">0%</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Delivery Rate</div>
                    </div>
                    <div style="background: var(--background); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div id="responseRateStat" style="font-size: 20px; font-weight: 700; color: var(--primary);">0%</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Response Rate</div>
                    </div>
                </div>

                <!-- Live Chat Interface -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; height: 600px;">
                    <!-- Conversation List -->
                    <div class="chart-container" style="height: 100%; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                            <h3 style="margin: 0 0 16px 0;">Recent Conversations</h3>
                            <input type="text" placeholder="Search conversations..." class="form-input">
                        </div>
                        <div style="flex: 1; overflow-y: auto;" id="conversationList">
                            <!-- Conversation list items -->
                        </div>
                    </div>

                    <!-- Chat View -->
                    <div class="chart-container" style="height: 100%; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                JD
                            </div>
                            <div>
                                <div style="font-weight: 600;">John Doe</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">+1 (555) 123-4567</div>
                            </div>
                            <div style="margin-left: auto;">
                                <span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                    Online
                                </span>
                            </div>
                        </div>
                        
                        <div style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa;" id="chatMessages">
                            <!-- Chat messages will be displayed here -->
                            <div style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                                <i class="ri-chat-3-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>

                        <div style="padding: 20px; border-top: 1px solid var(--border);">
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-secondary" style="padding: 8px;">
                                    <i class="ri-attachment-2"></i>
                                </button>
                                <button class="btn btn-secondary" style="padding: 8px;">
                                    <i class="ri-emotion-line"></i>
                                </button>
                                <input type="text" placeholder="Type your message..." class="form-input" style="flex: 1;">
                                <button class="btn btn-primary">
                                    <i class="ri-send-plane-fill"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Marketing Campaigns</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">Create and manage your WhatsApp marketing campaigns</p>
                    </div>
                    <button class="btn btn-primary" onclick="showCreateCampaignModal()">
                        <i class="ri-add-circle-fill"></i>
                        Create Campaign
                    </button>
                </div>

                <!-- Campaign Types -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: var(--radius); cursor: pointer;" onclick="createCampaignType('broadcast')">
                        <i class="ri-megaphone-fill" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <h3 style="margin: 0 0 8px 0;">Broadcast Campaign</h3>
                        <p style="opacity: 0.9; font-size: 14px;">Send messages to multiple customers at once</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 24px; border-radius: var(--radius); cursor: pointer;" onclick="createCampaignType('promotional')">
                        <i class="ri-price-tag-3-fill" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <h3 style="margin: 0 0 8px 0;">Promotional Campaign</h3>
                        <p style="opacity: 0.9; font-size: 14px;">Flash sales, discounts, and special offers</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 24px; border-radius: var(--radius); cursor: pointer;" onclick="createCampaignType('seasonal')">
                        <i class="ri-calendar-event-fill" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <h3 style="margin: 0 0 8px 0;">Seasonal Campaign</h3>
                        <p style="opacity: 0.9; font-size: 14px;">Holiday greetings and seasonal promotions</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 24px; border-radius: var(--radius); cursor: pointer;" onclick="createCampaignType('product_launch')">
                        <i class="ri-rocket-fill" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <h3 style="margin: 0 0 8px 0;">Product Launch</h3>
                        <p style="opacity: 0.9; font-size: 14px;">Announce new products and features</p>
                    </div>
                </div>

                <!-- Active Campaigns -->
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="margin: 0;">Active Campaigns</h3>
                        <div style="display: flex; gap: 8px;">
                            <select class="form-input" style="width: auto; padding: 8px 12px;">
                                <option>All Status</option>
                                <option>Active</option>
                                <option>Scheduled</option>
                                <option>Completed</option>
                                <option>Draft</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="campaignsList">
                        <!-- Campaigns will be loaded here -->
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="ri-megaphone-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            <p>No campaigns created yet</p>
                            <button class="btn btn-primary" onclick="showCreateCampaignModal()" style="margin-top: 16px;">
                                Create Your First Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="automation" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Advanced Automation</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">Configure intelligent automated workflows</p>
                    </div>
                    <button class="btn btn-primary" onclick="createFlow()">
                        <i class="ri-add-circle-fill"></i>
                        Create WhatsApp Flow
                    </button>
                </div>

                <!-- Advanced Abandoned Cart Section -->
                <div class="chart-container" style="margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="card-icon orange" style="width: 40px; height: 40px;">
                                <i class="ri-shopping-cart-2-fill"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0;">Abandoned Cart Recovery</h3>
                                <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0;">Advanced multi-step recovery sequence</p>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="abandonedCartAdvanced" checked onchange="toggleAdvancedCart()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="advancedCartConfig" style="display: block;">
                        <!-- Recovery Sequence -->
                        <div style="background: var(--background); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                            <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="ri-time-line"></i>
                                Recovery Sequence
                            </h4>
                            
                            <div style="display: grid; gap: 16px;">
                                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                                    <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">1</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; margin-bottom: 4px;">First Reminder</div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <select class="form-input" style="width: 80px; padding: 6px 8px;">
                                                <option>1</option>
                                                <option>2</option>
                                                <option>3</option>
                                                <option>6</option>
                                                <option>12</option>
                                            </select>
                                            <select class="form-input" style="width: 100px; padding: 6px 8px;">
                                                <option>Hours</option>
                                                <option>Minutes</option>
                                                <option>Days</option>
                                            </select>
                                            <span style="color: var(--text-secondary); font-size: 14px;">after cart abandonment</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" class="form-input" placeholder="Discount %" style="width: 80px; padding: 6px 8px;">
                                        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="editCartMessage(1)">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                    </div>
                                </div>

                                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                                    <div style="width: 32px; height: 32px; background: var(--info); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">2</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; margin-bottom: 4px;">Second Reminder</div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <select class="form-input" style="width: 80px; padding: 6px 8px;">
                                                <option>6</option>
                                                <option>12</option>
                                                <option>24</option>
                                            </select>
                                            <select class="form-input" style="width: 100px; padding: 6px 8px;">
                                                <option>Hours</option>
                                                <option>Days</option>
                                            </select>
                                            <span style="color: var(--text-secondary); font-size: 14px;">after first reminder</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" class="form-input" placeholder="Discount %" style="width: 80px; padding: 6px 8px;" value="15">
                                        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="editCartMessage(2)">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                    </div>
                                </div>

                                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                                    <div style="width: 32px; height: 32px; background: var(--warning); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">3</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; margin-bottom: 4px;">Final Reminder</div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <select class="form-input" style="width: 80px; padding: 6px 8px;">
                                                <option>3</option>
                                                <option>7</option>
                                                <option>14</option>
                                            </select>
                                            <select class="form-input" style="width: 100px; padding: 6px 8px;">
                                                <option>Days</option>
                                            </select>
                                            <span style="color: var(--text-secondary); font-size: 14px;">after second reminder</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" class="form-input" placeholder="Discount %" style="width: 80px; padding: 6px 8px;" value="20">
                                        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="editCartMessage(3)">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div style="background: var(--background); padding: 20px; border-radius: var(--radius);">
                            <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="ri-settings-4-line"></i>
                                Advanced Settings
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Minimum Cart Value</label>
                                    <input type="number" class="form-input" placeholder="25.00" style="padding: 8px 12px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Max Reminders per Customer</label>
                                    <select class="form-input" style="padding: 8px 12px;">
                                        <option>3</option>
                                        <option>5</option>
                                        <option>Unlimited</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Stop if Customer</label>
                                    <select class="form-input" style="padding: 8px 12px;">
                                        <option>Purchases anything</option>
                                        <option>Purchases same items</option>
                                        <option>Visits checkout</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Include Product Image</label>
                                    <select class="form-input" style="padding: 8px 12px;">
                                        <option>First item only</option>
                                        <option>All items</option>
                                        <option>None</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="abandonedCart">Abandoned Cart Recovery</label>
                        <p>Send WhatsApp messages to customers who abandon their carts</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="abandonedCart" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="orderConfirmation">Order Confirmation Messages</label>
                        <p>Automatically send order confirmations via WhatsApp</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="orderConfirmation" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="shippingUpdates">Shipping Updates</label>
                        <p>Notify customers when their order ships and is delivered</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="shippingUpdates" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="welcomeMessage">Welcome Messages</label>
                        <p>Send welcome messages to new customers</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="welcomeMessage" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="reviewRequest">Review Requests</label>
                        <p>Ask customers to leave reviews 3 days after delivery</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="reviewRequest">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="birthdayMessages">Birthday Messages</label>
                        <p>Send birthday wishes to customers</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="birthdayMessages">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group inline">
                    <div>
                        <label for="backInStock">Back in Stock Notifications</label>
                        <p>Notify customers when out-of-stock items are available</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="backInStock">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="saveAutomation()">
                    <i class="ri-save-line"></i>
                    Save Automation Settings
                </button>
                
                <!-- Existing Flows Section -->
                <div id="existing-flows" style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; font-size: 20px; font-weight: 600;">Your WhatsApp Flows</h3>
                    <div id="flows-container" class="loading">
                        <div class="empty-state">
                            <i class="ri-loader-4-line"></i>
                            <p>Loading flows...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="templates" class="tab-content">
                <h2 style="margin-bottom: 20px;">Message Templates</h2>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Abandoned Cart Reminder</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Hi {{customer_name}}! You left some items in your cart. Complete your purchase here: {{checkout_url}}
                    </div>
                </div>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Order Confirmation</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Thank you for your order #{{order_number}}! Your total is {{total_price}}. We'll notify you when it ships.
                    </div>
                </div>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Shipping Update</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Good news! Your order #{{order_number}} has shipped. Track it here: {{tracking_url}}
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addTemplate()">
                    <i class="ri-add-line"></i>
                    Add New Template
                </button>
            </div>
            
            <!-- WhatsApp Widget Tab -->
            <div id="widget" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">WhatsApp Widget</h2>
                        <p style="color: var(--text-secondary); margin-top: 4px;">Configure and install the WhatsApp chat button on your store</p>
                    </div>
                </div>
                
                <!-- Widget Configuration -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;">
                    <div style="background: var(--background); padding: 24px; border-radius: var(--radius);">
                        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-settings-4-line"></i>
                            Widget Settings
                        </h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">WhatsApp Phone Number</label>
                            <input type="tel" id="widgetPhone" placeholder="+1234567890" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Default Message</label>
                            <textarea id="widgetMessage" placeholder="Hello! I'm interested in your products." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Button Text</label>
                            <input type="text" id="widgetButtonText" placeholder="Chat with us" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Position</label>
                            <select id="widgetPosition" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Button Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="widgetBgColor" value="#25D366" style="width: 40px; height: 40px; border: none; border-radius: 4px; cursor: pointer;">
                                    <input type="text" id="widgetBgColorText" value="#25D366" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="widgetTextColor" value="#ffffff" style="width: 40px; height: 40px; border: none; border-radius: 4px; cursor: pointer;">
                                    <input type="text" id="widgetTextColorText" value="#ffffff" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--background); padding: 24px; border-radius: var(--radius);">
                        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-time-line"></i>
                            Business Hours
                        </h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="businessHoursEnabled">
                                <span>Enable business hours automation</span>
                            </label>
                        </div>
                        
                        <div id="businessHoursSettings" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Timezone</label>
                                <select id="widgetTimezone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (GMT-5)</option>
                                    <option value="America/Chicago">Central Time (GMT-6)</option>
                                    <option value="America/Denver">Mountain Time (GMT-7)</option>
                                    <option value="America/Los_Angeles">Pacific Time (GMT-8)</option>
                                    <option value="Europe/London">London Time (GMT+0)</option>
                                    <option value="Europe/Paris">Paris Time (GMT+1)</option>
                                    <option value="Asia/Dubai">Dubai Time (GMT+4)</option>
                                    <option value="Asia/Riyadh">Riyadh Time (GMT+3)</option>
                                    <option value="Asia/Tokyo">Tokyo Time (GMT+9)</option>
                                    <option value="Australia/Sydney">Sydney Time (GMT+11)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Weekly Schedule</h4>
                                <div id="businessHoursSchedule" style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                                    <!-- Monday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; background: #fafafa;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Monday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="monday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="monday_start" value="09:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="monday_end" value="17:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Tuesday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Tuesday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="tuesday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="tuesday_start" value="09:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="tuesday_end" value="17:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Wednesday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; background: #fafafa;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Wednesday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="wednesday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="wednesday_start" value="09:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="wednesday_end" value="17:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Thursday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Thursday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="thursday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="thursday_start" value="09:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="thursday_end" value="17:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Friday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; background: #fafafa;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Friday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="friday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="friday_start" value="09:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="friday_end" value="17:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Saturday -->
                                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Saturday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="saturday_closed">
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="saturday_start" value="10:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="saturday_end" value="14:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Sunday -->
                                    <div style="display: flex; align-items: center; padding: 12px;">
                                        <div style="flex: 0 0 80px; font-weight: 500;">Sunday</div>
                                        <label style="flex: 0 0 auto; margin-right: 12px; display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="sunday_closed" checked>
                                            <span style="font-size: 13px;">Closed</span>
                                        </label>
                                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                            <input type="time" id="sunday_start" value="10:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                                            <span style="color: #666;">to</span>
                                            <input type="time" id="sunday_end" value="14:00" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Closed Message</label>
                                <textarea id="widgetClosedMessage" placeholder="We're currently closed. Our business hours are Monday-Friday 9AM-5PM." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-notification-3-line"></i>
                            Smart Popups
                        </h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="popupTriggersEnabled">
                                <span>Enable smart popup triggers</span>
                            </label>
                        </div>
                        
                        <div id="popupSettings" style="display: none;">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Show after (seconds)</label>
                                <input type="number" id="popupDelay" value="5" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="popupExitIntent">
                                    <span>Show on exit intent</span>
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Show after scroll (%)</label>
                                <input type="number" id="popupScrollPercent" value="50" min="0" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Widget Preview and Installation -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div style="background: var(--background); padding: 24px; border-radius: var(--radius);">
                        <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-eye-line"></i>
                            Live Preview
                        </h3>
                        
                        <div id="widgetPreview" style="background: #f5f5f5; border-radius: 8px; padding: 40px; min-height: 300px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 8px; left: 8px; font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 1px;">Preview</div>
                            <div id="previewWidget" style="position: absolute; bottom: 20px; right: 20px;"></div>
                        </div>
                    </div>
                    
                    <div style="background: var(--background); padding: 24px; border-radius: var(--radius);">
                        <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-rocket-line"></i>
                            Installation Options
                        </h3>
                        
                        <!-- Automatic Installation -->
                        <div style="background: linear-gradient(135deg, #25D366, #20b858); padding: 16px; border-radius: 8px; color: white; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="ri-magic-line"></i>
                                Automatic Installation (Recommended)
                            </h4>
                            <p style="margin: 0 0 12px 0; opacity: 0.9; font-size: 14px;">Install the widget automatically to your store with one click. No code editing required!</p>
                            <button id="autoInstallBtn" onclick="automaticInstall()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <i class="ri-download-cloud-line"></i>
                                Install Widget Automatically
                            </button>
                        </div>
                        
                        <!-- Installation Status -->
                        <div id="installationStatus" style="display: none; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                            <div id="installationMessage" style="display: flex; align-items: center; gap: 8px;"></div>
                        </div>
                        
                        <!-- Manual Installation -->
                        <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                            <div style="background: #f8f9fa; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                <h4 style="margin: 0; font-size: 14px; color: #666;">Manual Installation (Alternative)</h4>
                            </div>
                            <div style="padding: 16px;">
                                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">For advanced users: Add this code to your theme's theme.liquid file before the closing &lt;/body&gt; tag:</p>
                                
                                <div style="background: #f8f8f8; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; font-family: monospace; font-size: 11px; position: relative; max-height: 150px; overflow-y: auto;">
                                    <button onclick="copyWidgetCode()" style="position: absolute; top: 8px; right: 8px; background: #25D366; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; z-index: 1;">Copy</button>
                                    <pre id="widgetEmbedCode" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; padding-right: 60px;">Loading embed code...</pre>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-secondary" onclick="window.open('/public/whatsapp-widget-setup.html', '_blank')" style="flex: 1;">
                                <i class="ri-external-link-line"></i>
                                Setup Guide
                            </button>
                            <button class="btn btn-success" onclick="testWidgetOnStore()" style="flex: 1;">
                                <i class="ri-eye-line"></i>
                                Test on Store
                            </button>
                            <button id="uninstallBtn" onclick="removeWidget()" style="background: #dc3545; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; display: none;">
                                <i class="ri-delete-bin-line"></i>
                                Remove Widget
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button class="btn btn-secondary" onclick="resetWidgetSettings()">
                        <i class="ri-refresh-line"></i>
                        Reset to Defaults
                    </button>
                    <button class="btn btn-primary" onclick="saveWidgetSettings()">
                        <i class="ri-save-line"></i>
                        Save Widget Settings
                    </button>
                </div>
            </div>
            
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">General Settings</h2>
                
                <div class="form-group">
                    <label>WhatsApp Business Number</label>
                    <input type="text" value="+1 415 523 8886" readonly>
                </div>
                
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" value="Your Store Name">
                </div>
                
                <div class="form-group">
                    <label>Default Language</label>
                    <select>
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>German</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Support Hours</label>
                    <input type="text" value="Mon-Fri 9AM-6PM EST">
                </div>
                
                <div class="form-group">
                    <label>Auto-Reply Outside Hours</label>
                    <textarea>Thank you for contacting us! We're currently closed but will respond to your message during our business hours: Mon-Fri 9AM-6PM EST.</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="ri-save-line"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Send WhatsApp Test Message
// In admin.html, update the sendWhatsAppTest function to use the working route:
function sendWhatsAppTest() {
    const phoneInput = document.getElementById('testPhoneInput');
    const messageInput = document.getElementById('testMessageInput');
    const resultDiv = document.getElementById('testResult');
    
    if (!phoneInput || !phoneInput.value) {
        resultDiv.style.display = 'block';
        resultDiv.className = 'test-result error';
        resultDiv.innerHTML = '<i class="ri-error-warning-line"></i> Please enter a phone number';
        return;
    }
    
    const phone = phoneInput.value.trim();
    const cleanPhone = phone.replace(/[\s+()-]/g, '');
    
    // Show loading
    resultDiv.style.display = 'block';
    resultDiv.className = 'test-result';
    resultDiv.innerHTML = '<i class="ri-loader-4-line"></i> Sending message...';
    
    // Use the WORKING endpoint you already have
    fetch(`/test-whatsapp-simple`)  // <-- Use your existing working endpoint
        .then(response => response.text())
        .then(html => {
            if (html.includes('Success')) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = '<i class="ri-checkbox-circle-line"></i> Message sent successfully! Check WhatsApp';
                phoneInput.value = '';
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = '<i class="ri-error-warning-line"></i> Failed to send message. Make sure you joined Twilio Sandbox!';
            }
        })
        .catch(error => {
            resultDiv.className = 'test-result error';
            resultDiv.innerHTML = '<i class="ri-error-warning-line"></i> Error: ' + error.message;
        });
}        
        // Switch tabs function
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load specific tab data when switching
            if (tabName === 'messages') {
                loadMessageStats();
            } else if (tabName === 'analytics') {
                loadRealStats();
            } else if (tabName === 'widget') {
                initializeWidgetTab();
            }
        }
        
        // Sync contacts function
        function syncContacts() {
            showToast('Syncing contacts from Shopify...', 'info');
            
            // Simulate sync with timeout
            setTimeout(() => {
                showToast('Contacts synced successfully!', 'success');
            }, 2000);
        }
        
        // View logs function
        function viewLogs() {
            showToast('Opening message logs...', 'info');
            // In production, redirect to logs page:
            // window.location.href = '/logs';
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'ri-checkbox-circle-line',
                error: 'ri-error-warning-line',
                info: 'ri-information-line',
                warning: 'ri-alert-line'
            };
            
            toast.innerHTML = `
                <i class="${icons[type]}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="ri-close-line"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 12px;
            `;
            document.body.appendChild(container);
            return container;
        }

        // Add toast styles
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            .toast {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 16px 20px;
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 300px;
                box-shadow: var(--shadow);
                animation: slideIn 0.3s ease-out;
                transition: opacity 0.3s;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .toast i:first-child {
                font-size: 20px;
            }
            
            .toast.success i:first-child { color: var(--success); }
            .toast.error i:first-child { color: var(--error); }
            .toast.info i:first-child { color: var(--info); }
            .toast.warning i:first-child { color: var(--warning); }
            
            .toast span {
                flex: 1;
                font-size: 14px;
                font-weight: 500;
            }
            
            .toast button {
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                padding: 4px;
                font-size: 18px;
            }
            
            .toast button:hover {
                color: var(--text-primary);
            }
        `;
        document.head.appendChild(toastStyles);

        // Global chart variables
        let mainChart = null;
        let pieChart = null;

        // Initialize Charts with real data
        async function initializeCharts() {
            try {
                await loadChartData();
            } catch (error) {
                console.error('Error loading chart data:', error);
                // Initialize with empty charts
                initializeEmptyCharts();
            }
        }

        // Load real chart data from APIs
        async function loadChartData() {
            const sessionToken = getSessionToken();
            const headers = sessionToken ? { 'Authorization': `Bearer ${sessionToken}` } : {};

            // Get orders data for main chart
            const ordersResponse = await fetch('/api/orders?days=7', { headers });
            const ordersData = await ordersResponse.json();

            // Get campaign analytics for pie chart
            const campaignResponse = await fetch('/api/campaign-analytics', { headers });
            const campaignData = await campaignResponse.json();

            if (ordersData.success && ordersData.orders) {
                updateMainChart(ordersData.orders);
            }

            if (campaignData.success && campaignData.campaigns) {
                updatePieChart(campaignData.campaigns);
            }
        }

        // Update main chart with real order/message data
        function updateMainChart(orders) {
            const mainCtx = document.getElementById('mainChart');
            if (!mainCtx) return;

            // Group orders by day for the last 7 days
            const last7Days = [];
            const messagesByDay = [];
            const revenueByDay = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayLabel = date.toLocaleDateString('en', { weekday: 'short' });
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);

                const dayOrders = orders.filter(order => {
                    const orderDate = new Date(order.createdAt);
                    return orderDate >= dayStart && orderDate <= dayEnd;
                });

                last7Days.push(dayLabel);
                messagesByDay.push(dayOrders.reduce((sum, order) => sum + (order.whatsappMessages || 0), 0));
                revenueByDay.push(dayOrders.reduce((sum, order) => sum + order.amount, 0));
            }

            if (mainChart) {
                mainChart.destroy();
            }

            mainChart = new Chart(mainCtx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'WhatsApp Messages',
                        data: messagesByDay,
                        borderColor: '#25D366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Revenue Generated',
                        data: revenueByDay,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Messages'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Revenue ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        }

        // Update pie chart with real campaign data
        function updatePieChart(campaigns) {
            const pieCtx = document.getElementById('pieChart');
            if (!pieCtx) return;

            const labels = campaigns.map(c => c.name);
            const data = campaigns.map(c => c.messagesSent);
            const colors = [
                '#25D366', '#3b82f6', '#f59e0b', '#8b5cf6', '#ef4444',
                '#10b981', '#f97316', '#6366f1', '#ec4899', '#14b8a6'
            ];

            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize empty charts as fallback
        function initializeEmptyCharts() {
            const mainCtx = document.getElementById('mainChart');
            const pieCtx = document.getElementById('pieChart');

            if (mainCtx) {
                new Chart(mainCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Messages Sent',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#25D366',
                            backgroundColor: 'rgba(37, 211, 102, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true }
                });
            }

            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No data'],
                        datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }]
                    },
                    options: { responsive: true }
                });
            }
        }

        // Advanced Cart Toggle
        function toggleAdvancedCart() {
            const isEnabled = document.getElementById('abandonedCartAdvanced').checked;
            const config = document.getElementById('advancedCartConfig');
            if (config) {
                config.style.display = isEnabled ? 'block' : 'none';
            }
        }

        // Navigate to Tab
        function navigateToTab(tabName) {
            switchTab(tabName);
        }

        // Load Real Customer Data from Shopify
        async function loadCustomerData() {
            const customerTable = document.getElementById('customerTable');
            
            try {
                // Show loading state
                if (customerTable) {
                    customerTable.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="ri-loader-4-line loading" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            <p>Loading customer data from Shopify...</p>
                        </div>
                    `;
                }

                const sessionToken = getSessionToken();
                const headers = sessionToken ? { 'Authorization': `Bearer ${sessionToken}` } : {};

                // Fetch real customer data from Shopify
                const response = await fetch('/api/customers', { headers });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch customer data');
                }

                const customers = data.customers || [];
                
                // Update customer stats
                if (data.stats) {
                    updateCustomerStats(data.stats);
                }

                if (customerTable) {
                    if (customers.length === 0) {
                        customerTable.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="ri-user-3-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <p>No customers found with phone numbers</p>
                                <button class="btn btn-primary" onclick="syncCustomers()" style="margin-top: 16px;">
                                    <i class="ri-refresh-line"></i>
                                    Sync from Shopify
                                </button>
                            </div>
                        `;
                        return;
                    }

                    customerTable.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Customer</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Phone</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Status</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Orders</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Total Spent</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">WhatsApp</th>
                                    <th style="text-align: left; padding: 12px; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customers.map(customer => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                                                    ${customer.name ? customer.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?'}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 500;">${customer.name || 'No Name'}</div>
                                                    <div style="font-size: 12px; color: var(--text-secondary);">${customer.email || ''}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; color: var(--text-secondary);">${customer.phone || 'No phone'}</td>
                                        <td style="padding: 12px;">
                                            <span style="background: ${customer.status === 'Active' ? 'var(--success)' : 'var(--text-muted)'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                                ${customer.status}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; color: var(--text-secondary);">${customer.ordersCount || 0}</td>
                                        <td style="padding: 12px; font-weight: 600;">$${customer.totalSpent || '0.00'}</td>
                                        <td style="padding: 12px;">
                                            ${customer.hasWhatsApp ? 
                                                `<span style="color: var(--success); font-size: 12px;">
                                                    <i class="ri-whatsapp-line"></i> ${customer.messagesCount || 0} msgs
                                                </span>` :
                                                `<span style="color: var(--text-muted); font-size: 12px;">No WhatsApp</span>`
                                            }
                                        </td>
                                        <td style="padding: 12px;">
                                            <div style="display: flex; gap: 4px;">
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewCustomer('${customer.id}')">
                                                    View
                                                </button>
                                                ${customer.phone ? 
                                                    `<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="messageCustomer('${customer.phone}')">
                                                        <i class="ri-chat-3-line"></i>
                                                    </button>` : ''
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error loading customer data:', error);
                if (customerTable) {
                    customerTable.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--error);">
                            <i class="ri-error-warning-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            <p>Failed to load customer data</p>
                            <button class="btn btn-secondary" onclick="loadCustomerData()" style="margin-top: 16px;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Update customer statistics in the UI
        function updateCustomerStats(stats) {
            // Update Total Customers
            const totalCustomersStat = document.getElementById('totalCustomersStat');
            if (totalCustomersStat) {
                totalCustomersStat.innerHTML = `
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${stats.totalCustomers || 0}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Total Customers</div>
                `;
            }

            // Update With WhatsApp
            const withWhatsAppStat = document.getElementById('withWhatsAppStat');
            if (withWhatsAppStat) {
                withWhatsAppStat.innerHTML = `
                    <div style="font-size: 24px; font-weight: 700; color: var(--success);">${stats.withWhatsApp || 0}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">With WhatsApp</div>
                `;
            }

            // Update Active Customers  
            const activeCustomersStat = document.getElementById('activeCustomersStat');
            if (activeCustomersStat) {
                activeCustomersStat.innerHTML = `
                    <div style="font-size: 24px; font-weight: 700; color: var(--info);">${stats.activeCustomers || 0}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Active</div>
                `;
            }

            // Update Inactive Customers
            const inactiveCustomersStat = document.getElementById('inactiveCustomersStat');
            if (inactiveCustomersStat) {
                inactiveCustomersStat.innerHTML = `
                    <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${stats.inactiveCustomers || 0}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Inactive</div>
                `;
            }

            console.log('Updated customer stats:', stats);
        }

        // Load Real Conversation List from database
        async function loadConversations() {
            const conversationList = document.getElementById('conversationList');
            
            try {
                // Show loading state
                if (conversationList) {
                    conversationList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="ri-loader-4-line loading" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                            <p>Loading conversations...</p>
                        </div>
                    `;
                }

                const sessionToken = getSessionToken();
                const headers = sessionToken ? { 'Authorization': `Bearer ${sessionToken}` } : {};

                // Get recent WhatsApp messages from database
                const response = await fetch('/api/recent-conversations', { headers });
                
                // If endpoint doesn't exist yet, use customer data as fallback
                let conversations = [];
                
                try {
                    const data = await response.json();
                    conversations = data.conversations || [];
                } catch {
                    // Fallback: get conversations from customer data
                    const customerResponse = await fetch('/api/customers', { headers });
                    const customerData = await customerResponse.json();
                    
                    if (customerData.success) {
                        conversations = customerData.customers
                            .filter(c => c.hasWhatsApp && c.messagesCount > 0)
                            .slice(0, 10)
                            .map(customer => ({
                                name: customer.name || 'No Name',
                                phone: customer.phone,
                                lastMessage: `${customer.messagesCount} message${customer.messagesCount !== 1 ? 's' : ''}`,
                                time: customer.lastMessageDate ? formatTime(customer.lastMessageDate) : 'Some time ago',
                                unread: 0 // Would need real-time tracking
                            }));
                    }
                }

                if (conversationList) {
                    if (conversations.length === 0) {
                        conversationList.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="ri-chat-3-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <p>No conversations yet</p>
                                <p style="font-size: 13px;">Start messaging customers to see conversations here</p>
                            </div>
                        `;
                        return;
                    }

                    conversationList.innerHTML = conversations.map(conv => `
                        <div style="padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;" 
                             onmouseover="this.style.background='var(--background)'" 
                             onmouseout="this.style.background='transparent'" 
                             onclick="selectConversation('${conv.phone || conv.name}', '${conv.name}')">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                                    ${conv.name ? conv.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?'}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--text-primary);">${conv.name}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${conv.time}</div>
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conv.lastMessage}</div>
                                </div>
                                ${conv.unread > 0 ? `<div style="width: 20px; height: 20px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${conv.unread}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                if (conversationList) {
                    conversationList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--error);">
                            <i class="ri-error-warning-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            <p>Failed to load conversations</p>
                            <button class="btn btn-secondary" onclick="loadConversations()" style="margin-top: 16px;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Format time for display
        function formatTime(dateString) {
            if (!dateString) return 'Unknown';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} min ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            } catch {
                return 'Unknown';
            }
        }

        // Customer functions
        function syncCustomers() {
            showToast('Syncing customers from Shopify...', 'info');
            setTimeout(() => {
                showToast('Customers synced successfully!', 'success');
                loadCustomerData();
            }, 2000);
        }

        function viewCustomer(phone) {
            showToast(`Opening customer profile for ${phone}`, 'info');
        }

        // Message customer function
        async function messageCustomer(phone, customerName = '') {
            if (!phone) {
                showToast('No phone number provided', 'error');
                return;
            }

            // Prompt user for message
            const message = prompt(`Send WhatsApp message to ${customerName || phone}:`);
            if (!message) return;

            try {
                showToast('Sending WhatsApp message...', 'info');
                
                const sessionToken = getSessionToken();
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        phone: phone,
                        message: message,
                        customerName: customerName
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('Message sent successfully!', 'success');
                    // Refresh conversations if on messages tab
                    if (document.getElementById('messages').classList.contains('active')) {
                        loadConversations();
                    }
                } else {
                    showToast('Failed to send message: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message. Please try again.', 'error');
            }
        }

        // Campaign functions
        function createCampaignType(type) {
            showToast(`Creating ${type} campaign...`, 'info');
        }

        function showCreateCampaignModal() {
            showToast('Campaign creation modal would open here', 'info');
        }

        function showBulkMessageModal() {
            showToast('Bulk message modal would open here', 'info');
        }

        function showImportModal() {
            showToast('Import contacts modal would open here', 'info');
        }

        function selectConversation(name) {
            showToast(`Selected conversation with ${name}`, 'info');
        }

        function editCartMessage(step) {
            showToast(`Editing cart recovery message ${step}`, 'info');
        }
        
        // Save automation settings
        async function saveAutomation() {
            const settings = {
                abandonedCart: document.getElementById('abandonedCart').checked,
                orderConfirmation: document.getElementById('orderConfirmation').checked,
                shippingUpdates: document.getElementById('shippingUpdates').checked,
                welcomeMessage: document.getElementById('welcomeMessage').checked,
                reviewRequest: document.getElementById('reviewRequest').checked,
                birthdayMessages: document.getElementById('birthdayMessages').checked,
                backInStock: document.getElementById('backInStock').checked
            };
            
            try {
                const sessionToken = getSessionToken();
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/automation-settings', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('Automation settings saved successfully!', 'success');
                } else {
                    showToast('Error saving settings: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error saving settings. Please try again.', 'error');
            }
        }

        // Load automation settings on page load
        async function loadAutomationSettings() {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/automation-settings', { headers });
                const result = await response.json();
                
                if (result.success) {
                    const settings = result.settings;
                    document.getElementById('abandonedCart').checked = settings.abandonedCart;
                    document.getElementById('orderConfirmation').checked = settings.orderConfirmation;
                    document.getElementById('shippingUpdates').checked = settings.shippingUpdates;
                    document.getElementById('welcomeMessage').checked = settings.welcomeMessage;
                    document.getElementById('reviewRequest').checked = settings.reviewRequest;
                    document.getElementById('birthdayMessages').checked = settings.birthdayMessages;
                    document.getElementById('backInStock').checked = settings.backInStock;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Navigate to Create Flow page
        function createFlow() {
            // Pass session token in URL
            const currentUrl = new URL(window.location);
            const createFlowUrl = `/create-flow.html${currentUrl.search}`;
            window.location.href = createFlowUrl;
        }

        // Load existing flows
        async function loadExistingFlows() {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/whatsapp-flows', { headers });
                const result = await response.json();
                
                const container = document.getElementById('flows-container');
                
                if (result.success && result.flows.length > 0) {
                    container.classList.remove('loading');
                    container.innerHTML = result.flows.map(flow => `
                        <div class="flow-card">
                            <div class="flow-header">
                                <div class="flow-info">
                                    <h4>${flow.flow_name}</h4>
                                    <div class="flow-meta">
                                        <span><i class="ri-price-tag-3-line"></i> ${flow.flow_type.replace('_', ' ').toUpperCase()}</span>
                                        <span><i class="ri-time-line"></i> ${flow.trigger_delay_minutes} min</span>
                                        <span><i class="ri-global-line"></i> ${flow.language.toUpperCase()}</span>
                                    </div>
                                </div>
                                <span class="flow-status ${flow.is_active ? 'active' : 'inactive'}">
                                    ${flow.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="flow-content">${flow.message_content.substring(0, 120)}...</div>
                            <div class="flow-actions">
                                <button onclick="editFlow(${flow.id})">
                                    <i class="ri-edit-line"></i> Edit
                                </button>
                                <button onclick="toggleFlow(${flow.id}, ${flow.is_active})">
                                    <i class="ri-toggle-line"></i> ${flow.is_active ? 'Disable' : 'Enable'}
                                </button>
                                <button class="delete" onclick="deleteFlow(${flow.id}, '${flow.flow_name.replace(/'/g, "\\'")}')" >
                                    <i class="ri-delete-bin-line"></i> Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.classList.remove('loading');
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="ri-flow-chart"></i>
                            <p>No WhatsApp flows created yet</p>
                            <button class="btn btn-primary" onclick="createFlow()">
                                <i class="ri-add-circle-fill"></i>
                                Create Your First Flow
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading flows:', error);
                document.getElementById('flows-container').innerHTML = `
                    <div class="empty-state">
                        <i class="ri-error-warning-line" style="color: var(--error);"></i>
                        <p style="color: var(--error);">Error loading flows</p>
                    </div>
                `;
            }
        }

        // Edit flow function
        function editFlow(flowId) {
            // Pass session token in URL
            const currentUrl = new URL(window.location);
            const searchParams = currentUrl.search;
            const separator = searchParams ? '&' : '?';
            const editFlowUrl = `/create-flow.html?edit=${flowId}${searchParams ? separator + searchParams.substring(1) : searchParams}`;
            window.location.href = editFlowUrl;
        }

        // Toggle flow active status
        async function toggleFlow(flowId, currentStatus) {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/whatsapp-flows/${flowId}/toggle`, {
                    method: 'PATCH',
                    headers: headers
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(`Flow ${currentStatus ? 'deactivated' : 'activated'} successfully!`, 'success');
                    loadExistingFlows(); // Reload the flows list
                } else {
                    showToast('Error updating flow: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error updating flow. Please try again.', 'error');
            }
        }

        // Delete flow
        async function deleteFlow(flowId, flowName) {
            if (!confirm(`Are you sure you want to delete the flow "${flowName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/whatsapp-flows/${flowId}`, {
                    method: 'DELETE',
                    headers: headers
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('Flow deleted successfully!', 'success');
                    loadExistingFlows(); // Reload the flows list
                } else {
                    showToast('Error deleting flow: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error deleting flow. Please try again.', 'error');
            }
        }
        
        // Add new template
        function addTemplate() {
            showToast('Opening template editor...', 'info');
            // In production, open a modal or redirect to template editor
        }
        
        // Save general settings
        function saveSettings() {
            showToast('Settings saved successfully!', 'success');
            // In production, gather all settings and save to backend
        }
        
        // WhatsApp Widget Functions
        let previewWidget = null;
        
        // Initialize widget tab functionality
        function initializeWidgetTab() {
            // Color picker sync
            document.getElementById('widgetBgColor').addEventListener('input', function() {
                document.getElementById('widgetBgColorText').value = this.value;
                updateWidgetPreview();
            });
            
            document.getElementById('widgetTextColor').addEventListener('input', function() {
                document.getElementById('widgetTextColorText').value = this.value;
                updateWidgetPreview();
            });
            
            document.getElementById('widgetBgColorText').addEventListener('input', function() {
                document.getElementById('widgetBgColor').value = this.value;
                updateWidgetPreview();
            });
            
            document.getElementById('widgetTextColorText').addEventListener('input', function() {
                document.getElementById('widgetTextColor').value = this.value;
                updateWidgetPreview();
            });
            
            // Business hours toggle
            document.getElementById('businessHoursEnabled').addEventListener('change', function() {
                document.getElementById('businessHoursSettings').style.display = this.checked ? 'block' : 'none';
                updateWidgetPreview();
            });
            
            // Popup triggers toggle
            document.getElementById('popupTriggersEnabled').addEventListener('change', function() {
                document.getElementById('popupSettings').style.display = this.checked ? 'block' : 'none';
                updateWidgetPreview();
            });
            
            // Business hours day toggles
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                const closedCheckbox = document.getElementById(day + '_closed');
                const startTime = document.getElementById(day + '_start');
                const endTime = document.getElementById(day + '_end');
                
                if (closedCheckbox && startTime && endTime) {
                    closedCheckbox.addEventListener('change', function() {
                        startTime.disabled = this.checked;
                        endTime.disabled = this.checked;
                        if (this.checked) {
                            startTime.style.opacity = '0.5';
                            endTime.style.opacity = '0.5';
                        } else {
                            startTime.style.opacity = '1';
                            endTime.style.opacity = '1';
                        }
                        updateWidgetPreview();
                    });
                    
                    startTime.addEventListener('change', updateWidgetPreview);
                    endTime.addEventListener('change', updateWidgetPreview);
                }
            });
            
            // Update preview on any input change
            const inputs = ['widgetPhone', 'widgetMessage', 'widgetButtonText', 'widgetPosition', 'widgetBgColorText', 'widgetTextColorText'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateWidgetPreview);
                    element.addEventListener('change', updateWidgetPreview);
                }
            });
            
            loadWidgetSettings();
            loadWidgetEmbedCode();
            checkInstallationStatus();
        }
        
        // Update widget preview
        function updateWidgetPreview() {
            const previewContainer = document.getElementById('previewWidget');
            if (!previewContainer) return;
            
            const phone = document.getElementById('widgetPhone').value || '+1234567890';
            const message = document.getElementById('widgetMessage').value || 'Hello! I\'m interested in your products.';
            const buttonText = document.getElementById('widgetButtonText').value || 'Chat with us';
            const bgColor = document.getElementById('widgetBgColorText').value || '#25D366';
            const textColor = document.getElementById('widgetTextColorText').value || '#ffffff';
            
            previewContainer.innerHTML = `
                <div style="
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background-color: ${bgColor};
                    color: ${textColor};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                </div>
            `;
        }
        
        // Load widget settings from API
        async function loadWidgetSettings() {
            try {
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/settings', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                const settings = await response.json();
                
                if (settings.phone_number) {
                    document.getElementById('widgetPhone').value = settings.phone_number;
                }
                if (settings.default_message) {
                    document.getElementById('widgetMessage').value = settings.default_message;
                }
                if (settings.button_text) {
                    document.getElementById('widgetButtonText').value = settings.button_text;
                }
                if (settings.position) {
                    document.getElementById('widgetPosition').value = settings.position;
                }
                if (settings.background_color) {
                    document.getElementById('widgetBgColor').value = settings.background_color;
                    document.getElementById('widgetBgColorText').value = settings.background_color;
                }
                if (settings.text_color) {
                    document.getElementById('widgetTextColor').value = settings.text_color;
                    document.getElementById('widgetTextColorText').value = settings.text_color;
                }
                if (settings.business_hours_enabled) {
                    document.getElementById('businessHoursEnabled').checked = settings.business_hours_enabled;
                    document.getElementById('businessHoursSettings').style.display = 'block';
                }
                if (settings.business_hours_timezone) {
                    document.getElementById('widgetTimezone').value = settings.business_hours_timezone;
                }
                if (settings.closed_message) {
                    document.getElementById('widgetClosedMessage').value = settings.closed_message;
                }
                
                // Load business hours schedule
                if (settings.business_hours_schedule) {
                    const schedule = typeof settings.business_hours_schedule === 'string' 
                        ? JSON.parse(settings.business_hours_schedule) 
                        : settings.business_hours_schedule;
                    
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    days.forEach(day => {
                        if (schedule[day]) {
                            const closedCheckbox = document.getElementById(day + '_closed');
                            const startTime = document.getElementById(day + '_start');
                            const endTime = document.getElementById(day + '_end');
                            
                            if (schedule[day].closed) {
                                closedCheckbox.checked = true;
                                startTime.disabled = true;
                                endTime.disabled = true;
                                startTime.style.opacity = '0.5';
                                endTime.style.opacity = '0.5';
                            } else {
                                closedCheckbox.checked = false;
                                if (schedule[day].start) startTime.value = schedule[day].start;
                                if (schedule[day].end) endTime.value = schedule[day].end;
                                startTime.disabled = false;
                                endTime.disabled = false;
                                startTime.style.opacity = '1';
                                endTime.style.opacity = '1';
                            }
                        }
                    });
                }
                
                if (settings.popup_triggers_enabled) {
                    document.getElementById('popupTriggersEnabled').checked = settings.popup_triggers_enabled;
                    document.getElementById('popupSettings').style.display = 'block';
                }
                if (settings.popup_delay) {
                    document.getElementById('popupDelay').value = Math.floor(settings.popup_delay / 1000);
                }
                if (settings.popup_exit_intent !== undefined) {
                    document.getElementById('popupExitIntent').checked = settings.popup_exit_intent;
                }
                if (settings.popup_scroll_percentage) {
                    document.getElementById('popupScrollPercent').value = settings.popup_scroll_percentage;
                }
                
                updateWidgetPreview();
            } catch (error) {
                console.error('Failed to load widget settings:', error);
            }
        }
        
        // Load widget embed code
        async function loadWidgetEmbedCode() {
            try {
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/embed-code', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                const data = await response.json();
                
                if (data.embedCode) {
                    document.getElementById('widgetEmbedCode').textContent = data.embedCode;
                }
            } catch (error) {
                console.error('Failed to load embed code:', error);
                document.getElementById('widgetEmbedCode').textContent = 'Error loading embed code. Please try again.';
            }
        }
        
        // Save widget settings
        async function saveWidgetSettings() {
            try {
                // Validate phone number first
                const phoneNumber = document.getElementById('widgetPhone').value;
                if (!phoneNumber || phoneNumber.trim() === '') {
                    showToast('Please enter your WhatsApp phone number first!', 'error');
                    return false;
                }
                
                // Collect business hours schedule
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const schedule = {};
                
                days.forEach(day => {
                    const closedCheckbox = document.getElementById(day + '_closed');
                    const startTime = document.getElementById(day + '_start');
                    const endTime = document.getElementById(day + '_end');
                    
                    if (closedCheckbox && startTime && endTime) {
                        schedule[day] = {
                            closed: closedCheckbox.checked,
                            start: startTime.value,
                            end: endTime.value
                        };
                    }
                });
                
                const settings = {
                    phoneNumber: phoneNumber,
                    defaultMessage: document.getElementById('widgetMessage').value || 'Hello! I\'m interested in your products.',
                    buttonText: document.getElementById('widgetButtonText').value || 'Chat with us',
                    position: document.getElementById('widgetPosition').value || 'bottom-right',
                    backgroundColor: document.getElementById('widgetBgColorText').value || '#25D366',
                    textColor: document.getElementById('widgetTextColorText').value || '#ffffff',
                    businessHours: {
                        enabled: document.getElementById('businessHoursEnabled').checked,
                        timezone: document.getElementById('widgetTimezone').value || 'UTC',
                        schedule: schedule,
                        closedMessage: document.getElementById('widgetClosedMessage').value || ''
                    },
                    popupTriggers: {
                        enabled: document.getElementById('popupTriggersEnabled').checked,
                        delay: parseInt(document.getElementById('popupDelay').value || 5) * 1000,
                        exitIntent: document.getElementById('popupExitIntent').checked,
                        scrollPercentage: parseInt(document.getElementById('popupScrollPercent').value || 50)
                    }
                };
                
                console.log('Saving widget settings:', settings);
                
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                console.log('Save response:', result);
                
                if (result.success) {
                    showToast('Widget settings saved successfully!', 'success');
                    loadWidgetEmbedCode(); // Refresh embed code
                    return true;
                } else {
                    showToast('Error saving widget settings: ' + (result.error || 'Unknown error'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving widget settings:', error);
                showToast('Error saving widget settings: ' + error.message, 'error');
                return false;
            }
        }
        
        // Reset widget settings to defaults
        function resetWidgetSettings() {
            if (confirm('Are you sure you want to reset all widget settings to defaults?')) {
                document.getElementById('widgetPhone').value = '';
                document.getElementById('widgetMessage').value = 'Hello! I\'m interested in your products.';
                document.getElementById('widgetButtonText').value = 'Chat with us';
                document.getElementById('widgetPosition').value = 'bottom-right';
                document.getElementById('widgetBgColor').value = '#25D366';
                document.getElementById('widgetBgColorText').value = '#25D366';
                document.getElementById('widgetTextColor').value = '#ffffff';
                document.getElementById('widgetTextColorText').value = '#ffffff';
                document.getElementById('businessHoursEnabled').checked = false;
                document.getElementById('businessHoursSettings').style.display = 'none';
                document.getElementById('popupTriggersEnabled').checked = false;
                document.getElementById('popupSettings').style.display = 'none';
                document.getElementById('popupDelay').value = 5;
                document.getElementById('popupScrollPercent').value = 50;
                document.getElementById('popupExitIntent').checked = false;
                document.getElementById('widgetClosedMessage').value = '';
                
                updateWidgetPreview();
                showToast('Widget settings reset to defaults', 'info');
            }
        }
        
        // Copy widget embed code
        function copyWidgetCode() {
            const code = document.getElementById('widgetEmbedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Embed code copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy code. Please select and copy manually.', 'error');
            });
        }
        
        // Test widget on store
        function testWidgetOnStore() {
            const shopDomain = getCurrentShop();
            if (shopDomain) {
                window.open(`https://${shopDomain}`, '_blank');
                showToast('Opening your store in a new tab. Look for the WhatsApp widget!', 'info');
            } else {
                showToast('Unable to determine store URL', 'error');
            }
        }
        
        // Check installation status
        async function checkInstallationStatus() {
            try {
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/installation-status', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                const data = await response.json();
                
                if (data.installed) {
                    showInstallationStatus('success', 'Widget is installed and active on your store!');
                    document.getElementById('autoInstallBtn').style.display = 'none';
                    document.getElementById('uninstallBtn').style.display = 'inline-block';
                } else {
                    showInstallationStatus('info', 'Widget is not yet installed on your store.');
                    document.getElementById('autoInstallBtn').style.display = 'inline-block';
                    document.getElementById('uninstallBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to check installation status:', error);
            }
        }
        
        // Show installation status message
        function showInstallationStatus(type, message) {
            const statusDiv = document.getElementById('installationStatus');
            const messageDiv = document.getElementById('installationMessage');
            
            let icon = '';
            let bgColor = '';
            
            switch (type) {
                case 'success':
                    icon = '<i class="ri-check-line"></i>';
                    bgColor = '#d4edda';
                    break;
                case 'error':
                    icon = '<i class="ri-error-warning-line"></i>';
                    bgColor = '#f8d7da';
                    break;
                case 'loading':
                    icon = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>';
                    bgColor = '#fff3cd';
                    break;
                default:
                    icon = '<i class="ri-information-line"></i>';
                    bgColor = '#d1ecf1';
            }
            
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = bgColor;
            messageDiv.innerHTML = `${icon} <span>${message}</span>`;
        }
        
        // Hide installation status
        function hideInstallationStatus() {
            document.getElementById('installationStatus').style.display = 'none';
        }
        
        // Automatic installation using Shopify Script Tags
        async function automaticInstall() {
            const phoneNumber = document.getElementById('widgetPhone').value;
            
            if (!phoneNumber) {
                showToast('Please enter your WhatsApp phone number first!', 'error');
                return;
            }
            
            showInstallationStatus('loading', 'Saving settings and installing widget...');
            document.getElementById('autoInstallBtn').disabled = true;
            
            try {
                // First save the current settings
                console.log('Step 1: Saving widget settings...');
                const settingsSaved = await saveWidgetSettings();
                
                if (!settingsSaved) {
                    showInstallationStatus('error', 'Failed to save widget settings. Please check your configuration.');
                    return;
                }
                
                console.log('Step 2: Installing via Script Tag API...');
                showInstallationStatus('loading', 'Installing widget on your store...');
                
                // Then install via Script Tag API
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/install', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const result = await response.json();
                console.log('Installation result:', result);
                
                if (result.success) {
                    showInstallationStatus('success', 'Widget successfully installed on your store! It may take a few minutes to appear.');
                    document.getElementById('autoInstallBtn').style.display = 'none';
                    document.getElementById('uninstallBtn').style.display = 'inline-block';
                    showToast('Widget installed successfully!', 'success');
                } else {
                    showInstallationStatus('error', 'Installation failed: ' + (result.error || 'Unknown error'));
                    showToast('Installation failed: ' + (result.error || 'Please try the manual method.'), 'error');
                }
            } catch (error) {
                console.error('Installation failed:', error);
                showInstallationStatus('error', 'Installation failed: ' + error.message);
                showToast('Installation failed: ' + error.message, 'error');
            } finally {
                document.getElementById('autoInstallBtn').disabled = false;
            }
        }
        
        // Remove widget from store
        async function removeWidget() {
            if (!confirm('Are you sure you want to remove the WhatsApp widget from your store?')) {
                return;
            }
            
            showInstallationStatus('loading', 'Removing widget from your store...');
            
            try {
                const sessionToken = getSessionToken();
                const response = await fetch('/api/whatsapp/uninstall', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showInstallationStatus('info', 'Widget successfully removed from your store.');
                    document.getElementById('autoInstallBtn').style.display = 'inline-block';
                    document.getElementById('uninstallBtn').style.display = 'none';
                    showToast('Widget removed successfully!', 'success');
                } else {
                    showInstallationStatus('error', 'Failed to remove widget: ' + (result.error || 'Unknown error'));
                    showToast('Failed to remove widget. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Failed to remove widget:', error);
                showInstallationStatus('error', 'Failed to remove widget. Please try again.');
                showToast('Failed to remove widget. Please try again.', 'error');
            }
        }
        
        // Load real stats on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded successfully!');
            loadRealStats();
        });
        
        // Get session token from URL params for API requests
        function getSessionToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id_token');
        }

        // Send template test message
        function sendTemplateTest() {
            const template = document.getElementById('templateSelect').value;
            const resultDiv = document.getElementById('templateResult');
            
            // Show loading
            resultDiv.style.display = 'block';
            resultDiv.style.color = '#666';
            resultDiv.innerHTML = '⏳ Sending template test...';
            
            const sessionToken = getSessionToken();
            const headers = {};
            
            if (sessionToken) {
                headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            fetch(`/api/test-notifications/${template}`, { headers })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultDiv.style.color = 'green';
                        resultDiv.innerHTML = `✅ ${template} template sent successfully!<br>Message ID: ${data.messageSid}`;
                    } else {
                        resultDiv.style.color = 'red';
                        resultDiv.innerHTML = `❌ Failed: ${data.error}`;
                    }
                })
                .catch(error => {
                    resultDiv.style.color = 'red';
                    resultDiv.innerHTML = `❌ Error: ${error.message}`;
                });
        }

        // Load real statistics from Shopify store
        function loadRealStats() {
            const sessionToken = getSessionToken();
            const headers = {};
            
            if (sessionToken) {
                headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            fetch('/api/stats', { headers })
                .then(response => response.json())
                .then(stats => {
                    console.log('Real stats loaded:', stats);
                    updateAnalyticsStats(stats);
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    // Show error state instead of mock data
                    showAnalyticsError();
                });
        }

        // Update analytics statistics with real data
        function updateAnalyticsStats(stats) {
            // Update main dashboard statistics
            const messagesToday = document.getElementById('messagesToday');
            if (messagesToday) {
                messagesToday.innerHTML = `
                    ${stats.messagesToday || 0}
                    <span class="stat-trend up">
                        <i class="ri-arrow-up-s-line"></i>
                        ${stats.messagesTodayGrowth || 0}%
                    </span>
                `;
            }

            const customersWhatsApp = document.getElementById('customersWhatsApp');
            if (customersWhatsApp) {
                customersWhatsApp.innerHTML = `
                    ${stats.customersWithPhone || 0}
                    <span class="stat-trend up">
                        <i class="ri-arrow-up-s-line"></i>
                        ${stats.customersGrowth || 0}%
                    </span>
                `;
            }

            const totalMessages = document.getElementById('totalMessages');
            if (totalMessages) {
                totalMessages.textContent = stats.totalMessages || 0;
            }

            // Update revenue impact
            const revenue30Days = document.getElementById('revenue30Days');
            if (revenue30Days) {
                revenue30Days.innerHTML = `
                    $${stats.revenue30Days || '0.00'}
                    <span class="stat-trend up">
                        <i class="ri-arrow-up-s-line"></i>
                        ${stats.revenueGrowth || 0}%
                    </span>
                `;
            }

            const conversionRate = document.getElementById('conversionRate');
            if (conversionRate) {
                conversionRate.textContent = `${stats.conversionRate || 0}%`;
            }

            const avgOrderValue = document.getElementById('avgOrderValue');
            if (avgOrderValue) {
                avgOrderValue.textContent = `$${stats.avgOrderValue || '0.00'}`;
            }

            // Update analytics tab performance metrics
            const analyticsDeliveryRate = document.getElementById('analyticsDeliveryRate');
            if (analyticsDeliveryRate) {
                analyticsDeliveryRate.innerHTML = `
                    ${stats.deliveryRate || 0}%
                    <span class="stat-trend up">
                        <i class="ri-arrow-up-s-line"></i>
                        ${stats.deliveryRateGrowth || 0}%
                    </span>
                `;
            }

            const analyticsOpenRate = document.getElementById('analyticsOpenRate');
            if (analyticsOpenRate) {
                analyticsOpenRate.textContent = `${stats.openRate || 0}%`;
            }

            const analyticsClickRate = document.getElementById('analyticsClickRate');
            if (analyticsClickRate) {
                analyticsClickRate.textContent = `${stats.clickRate || 0}%`;
            }

            const analyticsWhatsAppRevenue = document.getElementById('analyticsWhatsAppRevenue');
            if (analyticsWhatsAppRevenue) {
                analyticsWhatsAppRevenue.innerHTML = `
                    $${stats.whatsappRevenue || 0}
                    <span class="stat-trend up">
                        <i class="ri-arrow-up-s-line"></i>
                        ${stats.whatsappRevenueGrowth || 0}%
                    </span>
                `;
            }

            const analyticsConversionRate = document.getElementById('analyticsConversionRate');
            if (analyticsConversionRate) {
                analyticsConversionRate.textContent = `${stats.analyticsConversionRate || 0}%`;
            }

            const analyticsROAS = document.getElementById('analyticsROAS');
            if (analyticsROAS) {
                analyticsROAS.textContent = `${stats.roas || 0}x`;
            }

            // Update status
            const statusElement = document.querySelector('.status');
            if (statusElement) {
                if ((stats.messagesToday || 0) > 0 || (stats.totalMessages || 0) > 0) {
                    statusElement.textContent = 'Active';
                    statusElement.className = 'status active';
                } else {
                    statusElement.textContent = 'Ready';
                    statusElement.className = 'status inactive';
                }
            }
            
            // Also update cart recovery and campaign performance data
            updateCartRecoveryStats(stats);
            updateCampaignTable(stats.campaigns || []);
        }

        // Load message statistics for Messages tab
        function loadMessageStats() {
            const sessionToken = getSessionToken();
            const headers = {};
            
            if (sessionToken) {
                headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            fetch('/api/stats', { headers })
                .then(response => response.json())
                .then(stats => {
                    console.log('Message stats loaded:', stats);
                    updateMessageStats(stats);
                })
                .catch(error => {
                    console.error('Error loading message stats:', error);
                    // Show error state or fallback
                });
        }

        // Update message statistics in the Messages tab
        function updateMessageStats(stats) {
            // Update messagesTodayStat
            const messagesTodayStatElement = document.getElementById('messagesTodayStat');
            if (messagesTodayStatElement) {
                messagesTodayStatElement.textContent = stats.messagesToday || 0;
            }

            // Update messagesWeekStat
            const messagesWeekStatElement = document.getElementById('messagesWeekStat');
            if (messagesWeekStatElement) {
                messagesWeekStatElement.textContent = stats.messagesThisWeek || 0;
            }

            // Update deliveryRateStat
            const deliveryRateStatElement = document.getElementById('deliveryRateStat');
            if (deliveryRateStatElement) {
                deliveryRateStatElement.textContent = `${stats.deliveryRate || 0}%`;
            }

            // Update responseRateStat
            const responseRateStatElement = document.getElementById('responseRateStat');
            if (responseRateStatElement) {
                responseRateStatElement.textContent = `${stats.responseRate || 0}%`;
            }
        }

        // Update cart recovery statistics
        function updateCartRecoveryStats(stats) {
            const cartsRecoveredElement = document.getElementById('cartsRecoveredStat');
            if (cartsRecoveredElement) {
                cartsRecoveredElement.textContent = stats.cartsRecovered || 0;
            }

            const cartsRecoveredGrowthElement = document.getElementById('cartsRecoveredGrowthStat');
            if (cartsRecoveredGrowthElement) {
                cartsRecoveredGrowthElement.textContent = `${stats.cartsRecoveredGrowth || 0}%`;
            }

            const recoveryRateElement = document.getElementById('recoveryRateStat');
            if (recoveryRateElement) {
                recoveryRateElement.textContent = `${stats.recoveryRate || 0}%`;
            }

            const recoveredValueElement = document.getElementById('recoveredValueStat');
            if (recoveredValueElement) {
                recoveredValueElement.textContent = `$${stats.recoveredValue || 0}`;
            }
        }

        // Update campaign performance table
        function updateCampaignTable(campaigns) {
            const tableBody = document.getElementById('campaignsTableBody');
            if (!tableBody || !campaigns) return;

            if (campaigns.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 32px; text-align: center; color: var(--text-muted);">
                            <i class="ri-inbox-line" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No campaign data available yet
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = campaigns.map(campaign => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 16px 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 8px; height: 8px; background: ${campaign.color}; border-radius: 50%;"></div>
                            ${campaign.name}
                        </div>
                    </td>
                    <td style="padding: 16px 12px; color: var(--text-secondary);">${campaign.messages || 0}</td>
                    <td style="padding: 16px 12px; color: var(--text-secondary);">${campaign.deliveryRate || 0}%</td>
                    <td style="padding: 16px 12px; color: var(--text-secondary);">${campaign.clickRate || 0}%</td>
                    <td style="padding: 16px 12px; font-weight: 600;">$${campaign.revenue || 0}</td>
                    <td style="padding: 16px 12px;">
                        <span style="color: var(--success); font-weight: 600;">+${campaign.roi || 0}%</span>
                    </td>
                </tr>
            `).join('');
        }

        // Show error state for analytics
        function showAnalyticsError() {
            const elements = [
                'messagesToday', 'customersWhatsApp', 'totalMessages',
                'revenue30Days', 'conversionRate', 'avgOrderValue'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span style="color: var(--error);">Error</span>';
                }
            });
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeCharts();
            }, 500);
            
            // Load initial data
            loadAutomationSettings();
            loadExistingFlows();
            loadRealStats();
            loadCustomerData();
            loadConversations();
            
            console.log('WhatsApp Business Dashboard initialized successfully');
        });
    </script>
</body>
</html>