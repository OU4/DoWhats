<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Integration Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status.active {
            background: #10b981;
            color: white;
        }
        
        .status.inactive {
            background: #ef4444;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .stat:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .stat-value {
            color: #333;
            font-weight: 600;
            font-size: 18px;
        }
        
        .settings-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(32px);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .message-templates {
            margin-top: 30px;
        }
        
        .template-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .template-name {
            font-weight: 600;
            color: #333;
        }
        
        .template-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            background: #10b981;
            color: white;
        }
        
        .template-content {
            color: #666;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WhatsApp Integration Dashboard</h1>
            <p style="color: #666; margin-bottom: 15px;">Manage your WhatsApp automation and messaging</p>
            <span class="status active">Connected</span>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üìä Statistics</h2>
                <div class="stat">
                    <span class="stat-label">Messages Sent Today</span>
                    <span class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Customers with WhatsApp</span>
                    <span class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Messages Sent</span>
                    <span class="stat-value">0</span>
                </div>
            </div>
            
            <div class="card">
                <h2>üí∞ Revenue Impact</h2>
                <div class="stat">
                    <span class="stat-label">Revenue (30 days)</span>
                    <span class="stat-value">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">WhatsApp Conversion Rate</span>
                    <span class="stat-value">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Avg. Order Value</span>
                    <span class="stat-value">$0.00</span>
                </div>
            </div>
            
            <!-- Quick Actions Card with Test Message Form -->
            <div class="card">
                <h2>‚ö° Quick Actions</h2>
                
                <!-- Test Message Section -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 16px;">Send Test Message</h3>
                    
                    <div class="form-group">
                        <input type="text" 
                               id="testPhoneInput" 
                               placeholder="WhatsApp number (e.g., +1234567890)"
                               style="width: 100%; margin-bottom: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <textarea id="testMessageInput" 
                                  placeholder="Test message (optional)"
                                  style="width: 100%; margin-bottom: 10px; min-height: 60px;">Hello! This is a test message from your Shopify store. üõçÔ∏è</textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendWhatsAppTest()">
                        Send Test WhatsApp
                    </button>
                    
                    <div id="testResult" style="margin-top: 10px; display: none;"></div>
                    
                    <!-- Template Test Section -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">Test Notification Templates</h4>
                        <select id="templateSelect" style="margin-bottom: 10px; width: 100%;">
                            <option value="order_placed">Order Confirmation</option>
                            <option value="abandoned_cart_1h">Abandoned Cart</option>
                            <option value="welcome_customer">Welcome Message</option>
                            <option value="order_fulfilled">Shipping Update</option>
                        </select>
                        <button class="btn btn-primary" onclick="sendTemplateTest()">
                            Test Template
                        </button>
                        <div id="templateResult" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>
                
                <!-- Other buttons -->
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="syncContacts()">
                    Sync Contacts
                </button>
                <button class="btn btn-primary" style="width: 100%;" onclick="viewLogs()">
                    View Logs
                </button>
            </div>
        </div>
        
        <div class="settings-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('automation')">Automation</button>
                <button class="tab" onclick="switchTab('templates')">Templates</button>
                <button class="tab" onclick="switchTab('settings')">Settings</button>
            </div>
            
            <div id="automation" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0;">Automation Settings</h2>
                    <button class="btn btn-primary" onclick="createFlow()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 10px 20px; font-size: 14px;">
                        + Create WhatsApp Flow
                    </button>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="abandonedCart" checked>
                        Abandoned Cart Recovery
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Send WhatsApp messages to customers who abandon their carts
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="orderConfirmation" checked>
                        Order Confirmation Messages
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Automatically send order confirmations via WhatsApp
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="shippingUpdates" checked>
                        Shipping Updates
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Notify customers when their order ships and is delivered
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="welcomeMessage" checked>
                        Welcome Messages
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Send welcome messages to new customers
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reviewRequest">
                        Review Requests
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Ask customers to leave reviews 3 days after delivery
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="birthdayMessages">
                        Birthday Messages
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Send birthday wishes to customers
                    </p>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="backInStock">
                        Back in Stock Notifications
                    </label>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Notify customers when out-of-stock items are available
                    </p>
                </div>
                
                <button class="btn btn-primary" onclick="saveAutomation()">Save Automation Settings</button>
                
                <!-- Existing Flows Section -->
                <div id="existing-flows" style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px;">Your WhatsApp Flows</h3>
                    <div id="flows-container">
                        <p style="color: #666; text-align: center; padding: 20px;">Loading flows...</p>
                    </div>
                </div>
            </div>
            
            <div id="templates" class="tab-content">
                <h2 style="margin-bottom: 20px;">Message Templates</h2>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Abandoned Cart Reminder</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Hi {{customer_name}}! You left some items in your cart. Complete your purchase here: {{checkout_url}}
                    </div>
                </div>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Order Confirmation</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Thank you for your order #{{order_number}}! Your total is {{total_price}}. We'll notify you when it ships.
                    </div>
                </div>
                
                <div class="template-item">
                    <div class="template-header">
                        <span class="template-name">Shipping Update</span>
                        <span class="template-status">Active</span>
                    </div>
                    <div class="template-content">
                        Good news! Your order #{{order_number}} has shipped. Track it here: {{tracking_url}}
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addTemplate()">Add New Template</button>
            </div>
            
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px;">General Settings</h2>
                
                <div class="form-group">
                    <label>WhatsApp Business Number</label>
                    <input type="text" value="+1 415 523 8886" readonly>
                </div>
                
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" value="Your Store Name">
                </div>
                
                <div class="form-group">
                    <label>Default Language</label>
                    <select>
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>German</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Support Hours</label>
                    <input type="text" value="Mon-Fri 9AM-6PM EST">
                </div>
                
                <div class="form-group">
                    <label>Auto-Reply Outside Hours</label>
                    <textarea>Thank you for contacting us! We're currently closed but will respond to your message during our business hours: Mon-Fri 9AM-6PM EST.</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        // Send WhatsApp Test Message
// In admin.html, update the sendWhatsAppTest function to use the working route:
function sendWhatsAppTest() {
    const phoneInput = document.getElementById('testPhoneInput');
    const messageInput = document.getElementById('testMessageInput');
    const resultDiv = document.getElementById('testResult');
    
    if (!phoneInput || !phoneInput.value) {
        resultDiv.style.display = 'block';
        resultDiv.style.color = 'red';
        resultDiv.innerHTML = '‚ùå Please enter a phone number';
        return;
    }
    
    const phone = phoneInput.value.trim();
    const cleanPhone = phone.replace(/[\s+()-]/g, '');
    
    // Show loading
    resultDiv.style.display = 'block';
    resultDiv.style.color = '#666';
    resultDiv.innerHTML = '‚è≥ Sending message...';
    
    // Use the WORKING endpoint you already have
    fetch(`/test-whatsapp-simple`)  // <-- Use your existing working endpoint
        .then(response => response.text())
        .then(html => {
            if (html.includes('Success')) {
                resultDiv.style.color = 'green';
                resultDiv.innerHTML = '‚úÖ Message sent successfully! Check WhatsApp';
                phoneInput.value = '';
            } else {
                resultDiv.style.color = 'red';
                resultDiv.innerHTML = '‚ùå Failed to send message. Make sure you joined Twilio Sandbox!';
            }
        })
        .catch(error => {
            resultDiv.style.color = 'red';
            resultDiv.innerHTML = '‚ùå Error: ' + error.message;
        });
}        
        // Switch tabs function
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // Sync contacts function
        function syncContacts() {
            alert('Syncing contacts from Shopify...');
            // In production, this would make an API call like:
            /*
            fetch('/api/sync-contacts', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert('Contacts synced: ' + data.count);
            });
            */
        }
        
        // View logs function
        function viewLogs() {
            alert('Opening message logs...');
            // In production, redirect to logs page:
            // window.location.href = '/logs';
        }
        
        // Save automation settings
        async function saveAutomation() {
            const settings = {
                abandonedCart: document.getElementById('abandonedCart').checked,
                orderConfirmation: document.getElementById('orderConfirmation').checked,
                shippingUpdates: document.getElementById('shippingUpdates').checked,
                welcomeMessage: document.getElementById('welcomeMessage').checked,
                reviewRequest: document.getElementById('reviewRequest').checked,
                birthdayMessages: document.getElementById('birthdayMessages').checked,
                backInStock: document.getElementById('backInStock').checked
            };
            
            try {
                const sessionToken = getSessionToken();
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/automation-settings', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Automation settings saved successfully!');
                } else {
                    alert('‚ùå Error saving settings: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error saving settings. Please try again.');
            }
        }

        // Load automation settings on page load
        async function loadAutomationSettings() {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/automation-settings', { headers });
                const result = await response.json();
                
                if (result.success) {
                    const settings = result.settings;
                    document.getElementById('abandonedCart').checked = settings.abandonedCart;
                    document.getElementById('orderConfirmation').checked = settings.orderConfirmation;
                    document.getElementById('shippingUpdates').checked = settings.shippingUpdates;
                    document.getElementById('welcomeMessage').checked = settings.welcomeMessage;
                    document.getElementById('reviewRequest').checked = settings.reviewRequest;
                    document.getElementById('birthdayMessages').checked = settings.birthdayMessages;
                    document.getElementById('backInStock').checked = settings.backInStock;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Navigate to Create Flow page
        function createFlow() {
            // Pass session token in URL
            const currentUrl = new URL(window.location);
            const createFlowUrl = `/create-flow.html${currentUrl.search}`;
            window.location.href = createFlowUrl;
        }

        // Load existing flows
        async function loadExistingFlows() {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/whatsapp-flows', { headers });
                const result = await response.json();
                
                const container = document.getElementById('flows-container');
                
                if (result.success && result.flows.length > 0) {
                    container.innerHTML = result.flows.map(flow => `
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #1e293b;">${flow.flow_name}</h4>
                                <span style="background: ${flow.is_active ? '#10b981' : '#6b7280'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    ${flow.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                                <span style="color: #64748b; font-size: 14px;">Type: ${flow.flow_type.replace('_', ' ').toUpperCase()}</span>
                                <span style="color: #64748b; font-size: 14px;">Language: ${flow.language.toUpperCase()}</span>
                                <span style="color: #64748b; font-size: 14px;">Delay: ${flow.trigger_delay_minutes} min</span>
                            </div>
                            <p style="color: #64748b; font-size: 13px; margin: 8px 0; line-height: 1.4;">${flow.message_content.substring(0, 100)}...</p>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button onclick="editFlow(${flow.id})" style="padding: 6px 12px; background: #4f46e5; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Edit</button>
                                <button onclick="toggleFlow(${flow.id}, ${flow.is_active})" style="padding: 6px 12px; background: ${flow.is_active ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    ${flow.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                                <button onclick="deleteFlow(${flow.id}, '${flow.flow_name.replace(/'/g, "\\'")}')" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <p style="margin-bottom: 16px;">No WhatsApp flows created yet</p>
                            <button onclick="createFlow()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Create Your First Flow
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading flows:', error);
                document.getElementById('flows-container').innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 20px;">Error loading flows</p>
                `;
            }
        }

        // Edit flow function
        function editFlow(flowId) {
            // Pass session token in URL
            const currentUrl = new URL(window.location);
            const searchParams = currentUrl.search;
            const separator = searchParams ? '&' : '?';
            const editFlowUrl = `/create-flow.html?edit=${flowId}${searchParams ? separator + searchParams.substring(1) : searchParams}`;
            window.location.href = editFlowUrl;
        }

        // Toggle flow active status
        async function toggleFlow(flowId, currentStatus) {
            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/whatsapp-flows/${flowId}/toggle`, {
                    method: 'PATCH',
                    headers: headers
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Flow ${currentStatus ? 'deactivated' : 'activated'} successfully!`);
                    loadExistingFlows(); // Reload the flows list
                } else {
                    alert('‚ùå Error updating flow: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error updating flow. Please try again.');
            }
        }

        // Delete flow
        async function deleteFlow(flowId, flowName) {
            if (!confirm(`Are you sure you want to delete the flow "${flowName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const sessionToken = getSessionToken();
                const headers = {};
                
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/whatsapp-flows/${flowId}`, {
                    method: 'DELETE',
                    headers: headers
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Flow deleted successfully!');
                    loadExistingFlows(); // Reload the flows list
                } else {
                    alert('‚ùå Error deleting flow: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error deleting flow. Please try again.');
            }
        }
        
        // Add new template
        function addTemplate() {
            alert('Opening template editor...');
            // In production, open a modal or redirect to template editor
        }
        
        // Save general settings
        function saveSettings() {
            alert('Settings saved successfully!');
            // In production, gather all settings and save to backend
        }
        
        // Load real stats on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded successfully!');
            loadRealStats();
        });
        
        // Get session token from URL params for API requests
        function getSessionToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id_token');
        }

        // Send template test message
        function sendTemplateTest() {
            const template = document.getElementById('templateSelect').value;
            const resultDiv = document.getElementById('templateResult');
            
            // Show loading
            resultDiv.style.display = 'block';
            resultDiv.style.color = '#666';
            resultDiv.innerHTML = '‚è≥ Sending template test...';
            
            const sessionToken = getSessionToken();
            const headers = {};
            
            if (sessionToken) {
                headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            fetch(`/api/test-notifications/${template}`, { headers })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultDiv.style.color = 'green';
                        resultDiv.innerHTML = `‚úÖ ${template} template sent successfully!<br>Message ID: ${data.messageSid}`;
                    } else {
                        resultDiv.style.color = 'red';
                        resultDiv.innerHTML = `‚ùå Failed: ${data.error}`;
                    }
                })
                .catch(error => {
                    resultDiv.style.color = 'red';
                    resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                });
        }

        // Load real statistics from Shopify store
        function loadRealStats() {
            const sessionToken = getSessionToken();
            const headers = {};
            
            if (sessionToken) {
                headers['Authorization'] = `Bearer ${sessionToken}`;
            }
            
            fetch('/api/stats', { headers })
                .then(response => response.json())
                .then(stats => {
                    console.log('Real stats loaded:', stats);
                    
                    // Update Statistics section
                    const statValues = document.querySelectorAll('.stat-value');
                    if (statValues[0]) statValues[0].textContent = stats.messagesToday;
                    if (statValues[1]) statValues[1].textContent = stats.customersWithPhone;
                    if (statValues[2]) statValues[2].textContent = stats.totalMessages;
                    
                    // Update Revenue Impact section  
                    if (statValues[3]) statValues[3].textContent = `${stats.currencyCode} ${stats.revenue30Days}`;
                    if (statValues[4]) statValues[4].textContent = `${stats.conversionRate}%`;
                    if (statValues[5]) statValues[5].textContent = `${stats.currencyCode} ${stats.avgOrderValue}`;
                    
                    // Update status
                    const statusElement = document.querySelector('.status');
                    if (statusElement) {
                        if (stats.messagesToday > 0 || stats.totalMessages > 0) {
                            statusElement.textContent = 'Active';
                            statusElement.className = 'status active';
                        } else {
                            statusElement.textContent = 'Ready';
                            statusElement.className = 'status inactive';
                        }
                    }
                    
                    // Show error if data fetch failed
                    if (stats.error) {
                        console.warn('Using fallback data:', stats.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    // Keep mock data as fallback
                });
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadAutomationSettings();
            loadExistingFlows();
            loadStats();
        });
    </script>
</body>
</html>